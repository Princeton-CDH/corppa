<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Code Documentation &#8212; corppa 0.3 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=b489f392"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Ends of Prosody: corppa utilities" href="eop-docs.html" />
    <link rel="prev" title="Developer Notes" href="dev-notes.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="code-documentation">
<h1>Code Documentation<a class="headerlink" href="#code-documentation" title="Link to this heading">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<section id="module-corppa.ocr.gvision_ocr">
<span id="ocr"></span><h2>OCR<a class="headerlink" href="#module-corppa.ocr.gvision_ocr" title="Link to this heading">¶</a></h2>
<p>This script OCRs images using the Google Vision API.</p>
<dl class="py function">
<dt class="sig sig-object py" id="corppa.ocr.gvision_ocr.ocr_image_via_gvision">
<span class="sig-prename descclassname"><span class="pre">corppa.ocr.gvision_ocr.</span></span><span class="sig-name descname"><span class="pre">ocr_image_via_gvision</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">gvision_client</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">google_vision.ImageAnnotatorClient</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">input_image</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">out_txt</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">out_json</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span></span><a class="headerlink" href="#corppa.ocr.gvision_ocr.ocr_image_via_gvision" title="Link to this definition">¶</a></dt>
<dd><p>Perform OCR for input image using the Google Cloud Vision API via the provided client.
The plaintext output and json response of the OCR call are written to <code class="docutils literal notranslate"><span class="pre">out_txt</span></code> and
<code class="docutils literal notranslate"><span class="pre">out_json</span></code> paths respectively.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="corppa.ocr.gvision_ocr.ocr_images">
<span class="sig-prename descclassname"><span class="pre">corppa.ocr.gvision_ocr.</span></span><span class="sig-name descname"><span class="pre">ocr_images</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">in_dir</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">out_dir</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">exts</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Iterable" title="(in Python v3.13)"><span class="pre">Iterable</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ocr_limit</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">show_progress</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.13)"><span class="pre">bool</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.13)"><span class="pre">dict</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#corppa.ocr.gvision_ocr.ocr_images" title="Link to this definition">¶</a></dt>
<dd><p>OCR images in in_dir with extension exts to out_dir. If ocr_limit &gt; 0,
stop after OCRing ocr_limit images.</p>
<p>Returns a map structure reporting the number of images OCR’d and skipped.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="corppa.ocr.gvision_ocr.ocr_volumes">
<span class="sig-prename descclassname"><span class="pre">corppa.ocr.gvision_ocr.</span></span><span class="sig-name descname"><span class="pre">ocr_volumes</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">vol_ids</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.13)"><span class="pre">list</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">in_dir</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">out_dir</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">exts</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Iterable" title="(in Python v3.13)"><span class="pre">Iterable</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ocr_limit</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">show_progress</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.13)"><span class="pre">bool</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.13)"><span class="pre">None</span></a></span></span><a class="headerlink" href="#corppa.ocr.gvision_ocr.ocr_volumes" title="Link to this definition">¶</a></dt>
<dd><p>OCR images for volumes <code class="docutils literal notranslate"><span class="pre">vol_ids</span></code> with extension exts to <code class="docutils literal notranslate"><span class="pre">out_dir</span></code>. Assumes <code class="docutils literal notranslate"><span class="pre">in_dir</span></code>
follows the PPA directory conventions (see <a class="reference internal" href="#module-corppa.utils.path_utils" title="corppa.utils.path_utils"><code class="xref py py-mod docutils literal notranslate"><span class="pre">corppa.utils.path_utils</span></code></a> for more
details). If <code class="docutils literal notranslate"><span class="pre">ocr_limit</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>, stop after OCRing <code class="docutils literal notranslate"><span class="pre">ocr_limit</span></code> images.</p>
</dd></dl>

<section id="module-corppa.ocr.collate_txt">
<span id="collate-texts"></span><h3>Collate Texts<a class="headerlink" href="#module-corppa.ocr.collate_txt" title="Link to this heading">¶</a></h3>
<p>Script to turn directories containing multiple text files into a single <code class="docutils literal notranslate"><span class="pre">JSON</span></code>
file containing text contents of all files with page numbers based
on text filenames. (Page number logic is currently Gale-specific).</p>
<p>Note: This was used to create work-level text corpora files after running OCR.</p>
<p>Example usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">collate_txt</span><span class="o">.</span><span class="n">py</span> <span class="n">top</span><span class="o">-</span><span class="n">level</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="nb">dir</span> <span class="n">top</span><span class="o">-</span><span class="n">level</span><span class="o">-</span><span class="n">output</span><span class="o">-</span><span class="nb">dir</span>
</pre></div>
</div>
</section>
</section>
<section id="utils">
<h2>Utils<a class="headerlink" href="#utils" title="Link to this heading">¶</a></h2>
<section id="module-corppa.utils.filter">
<span id="filter-utility"></span><h3>Filter Utility<a class="headerlink" href="#module-corppa.utils.filter" title="Link to this heading">¶</a></h3>
<p>Utility for filtering PPA full-text corpus to work with a subset of
pages.</p>
<dl class="simple">
<dt>Currently supports the following types of filtering:</dt><dd><ul class="simple">
<li><p>List of PPA work ids (as a text file, id-per-line)</p></li>
<li><p>CSV file specifying work pages (by digital page number) (csv, page-per-line)</p></li>
<li><p>Filtering by key-value pair for either inclusion or exclusion</p></li>
</ul>
</dd>
</dl>
<p>These filtering options can be combined, generally as a logical AND. Pages filtered
by work ids or page numbers will be further filtered by the key-value logic. In cases
where both work- and page-level filtering occurs, works not specified in the page
filtering are included in full. Works that are specified in both will be limited to the
pages specified in page-level filtering.</p>
<p>Filter methods can be run via command-line or python code. Filtering takes a jsonl file
(compressed or not) as input, and will produce a jsonl file (compressed or not) as output.
The input and output filenames can use any extension supported by <code class="xref py py-mod docutils literal notranslate"><span class="pre">orjsonl</span></code>, with or
without compression (e.g. <code class="docutils literal notranslate"><span class="pre">.jsonl</span></code>, <code class="docutils literal notranslate"><span class="pre">.jsonl.gz</span></code>, <code class="docutils literal notranslate"><span class="pre">.jsonl.bz2</span></code>).</p>
<p>Example command line usages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">corppa</span><span class="o">-</span><span class="nb">filter</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">ppa_pages</span><span class="o">.</span><span class="n">jsonl</span> <span class="n">output</span><span class="o">/</span><span class="n">ppa_subset_pages</span><span class="o">.</span><span class="n">jsonl</span> <span class="o">--</span><span class="n">idfile</span> <span class="n">my_ids</span><span class="o">.</span><span class="n">txt</span>

<span class="n">corppa</span><span class="o">-</span><span class="nb">filter</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">ppa_pages</span><span class="o">.</span><span class="n">jsonl</span> <span class="n">output</span><span class="o">/</span><span class="n">ppa_subset_pages</span><span class="o">.</span><span class="n">jsonl</span> <span class="o">--</span><span class="n">pg</span><span class="o">-</span><span class="n">file</span> <span class="n">pages</span><span class="o">.</span><span class="n">csv</span> <span class="o">--</span><span class="n">include</span> <span class="n">key</span><span class="o">=</span><span class="n">value</span>
</pre></div>
</div>
</section>
<section id="module-corppa.utils.path_utils">
<span id="path-utilities"></span><h3>Path Utilities<a class="headerlink" href="#module-corppa.utils.path_utils" title="Link to this heading">¶</a></h3>
<p>General-purpose methods for working with paths, PPA identifiers, and directories</p>
<dl class="py function">
<dt class="sig sig-object py" id="corppa.utils.path_utils.decode_htid">
<span class="sig-prename descclassname"><span class="pre">corppa.utils.path_utils.</span></span><span class="sig-name descname"><span class="pre">decode_htid</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">encoded_htid</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></span><a class="headerlink" href="#corppa.utils.path_utils.decode_htid" title="Link to this definition">¶</a></dt>
<dd><p>Return original HathiTrust volume identifier from encoded version:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">library</span> <span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="p">[</span><span class="n">encoded</span> <span class="n">volume</span> <span class="nb">id</span><span class="p">]</span>
</pre></div>
</div>
<p>Specifically, the volume-portion of the id undergoes the following
character replacements:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;+&quot;</span> <span class="o">--&gt;</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span> <span class="o">--&gt;</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span> <span class="o">--&gt;</span> <span class="s2">&quot;.&quot;</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="corppa.utils.path_utils.encode_htid">
<span class="sig-prename descclassname"><span class="pre">corppa.utils.path_utils.</span></span><span class="sig-name descname"><span class="pre">encode_htid</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">htid</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></span><a class="headerlink" href="#corppa.utils.path_utils.encode_htid" title="Link to this definition">¶</a></dt>
<dd><p>Returns the “clean” version of a HathiTrust volume identifier with the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">library</span> <span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="p">[</span><span class="n">volume</span> <span class="nb">id</span><span class="p">]</span>
</pre></div>
</div>
<p>Specifically, the volume-portion of the id undergoes the following
character replacements:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;:&quot;</span> <span class="o">--&gt;</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span> <span class="o">--&gt;</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span> <span class="o">--&gt;</span> <span class="s2">&quot;,&quot;</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="corppa.utils.path_utils.find_relative_paths">
<span class="sig-prename descclassname"><span class="pre">corppa.utils.path_utils.</span></span><span class="sig-name descname"><span class="pre">find_relative_paths</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">base_dir</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">exts</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Iterable" title="(in Python v3.13)"><span class="pre">Iterable</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">follow_symlinks</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.13)"><span class="pre">bool</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">group_by_dir</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.13)"><span class="pre">bool</span></a></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Iterator" title="(in Python v3.13)"><span class="pre">Iterator</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a><span class="p"><span class="pre">]</span></span><span class="w"> </span><span class="p"><span class="pre">|</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/collections.abc.html#collections.abc.Iterator" title="(in Python v3.13)"><span class="pre">Iterator</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.13)"><span class="pre">tuple</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a><span class="p"><span class="pre">,</span></span><span class="w"> </span><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.13)"><span class="pre">list</span></a><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">]</span></span></span></span><a class="headerlink" href="#corppa.utils.path_utils.find_relative_paths" title="Link to this definition">¶</a></dt>
<dd><p>This method finds files anywhere under the specified base directory
that match any of the specified file extensions (case insensitive),
and returns a generator of path objects with a path relative to the
base directory. File extensions should include the leading period,
i.e. <code class="docutils literal notranslate"><span class="pre">[&quot;.jpg&quot;,</span> <span class="pre">&quot;.tiff&quot;]</span></code> rather than <code class="docutils literal notranslate"><span class="pre">[&quot;jpg&quot;,</span> <span class="pre">&quot;tiff&quot;]</span></code>.</p>
<p>For example, given a base directory <code class="docutils literal notranslate"><span class="pre">a/b/c/images</span></code>, an extension list of <code class="docutils literal notranslate"><span class="pre">.jpg</span></code>,
and files nested at different levels in the hierarchy
<code class="docutils literal notranslate"><span class="pre">a/b/c/images/alpha.jpg</span></code>, <code class="docutils literal notranslate"><span class="pre">a/b/c/images/d/beta.jpg</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">/</span><span class="n">b</span><span class="o">/</span><span class="n">c</span><span class="o">/</span><span class="n">images</span>
  <span class="o">|--</span> <span class="n">alpha</span><span class="o">.</span><span class="n">jpg</span>
  <span class="o">+--</span> <span class="n">d</span>
      <span class="o">|--</span> <span class="n">beta</span><span class="o">.</span><span class="n">jpg</span>
</pre></div>
</div>
<p>The result will include the two items: <code class="docutils literal notranslate"><span class="pre">alpha.jpg</span></code> and <code class="docutils literal notranslate"><span class="pre">d/beta.jpg</span></code></p>
<p>When <code class="docutils literal notranslate"><span class="pre">group_by_dir</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>, resulting files will be returned grouped
by the parent directory. The return result is a tuple of a single <a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">pathlib.Path</span></code></a>
object for the directory and a list of <a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">pathlib.Path</span></code></a> objects for the files in that
directory that match the specified extensions.  Given a hierarchy like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">images</span><span class="o">/</span><span class="n">vol</span><span class="o">-</span><span class="n">a</span><span class="o">/</span>
  <span class="o">|--</span> <span class="n">alpha</span><span class="o">.</span><span class="n">jpg</span>
  <span class="o">|--</span> <span class="n">beta</span><span class="o">.</span><span class="n">jpg</span>
</pre></div>
</div>
<p>the method would return <code class="docutils literal notranslate"><span class="pre">(vol-a,</span> <span class="pre">[alpha.jpg,</span> <span class="pre">beta.jpg])</span></code>.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="corppa.utils.path_utils.get_image_relpath">
<span class="sig-prename descclassname"><span class="pre">corppa.utils.path_utils.</span></span><span class="sig-name descname"><span class="pre">get_image_relpath</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">work_id</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">page_num</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><span class="pre">int</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a></span></span><a class="headerlink" href="#corppa.utils.path_utils.get_image_relpath" title="Link to this definition">¶</a></dt>
<dd><p>Get the (relative) image path for specified PPA work page</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="corppa.utils.path_utils.get_page_number">
<span class="sig-prename descclassname"><span class="pre">corppa.utils.path_utils.</span></span><span class="sig-name descname"><span class="pre">get_page_number</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">pagefile</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></span><a class="headerlink" href="#corppa.utils.path_utils.get_page_number" title="Link to this definition">¶</a></dt>
<dd><p>Extract and return the page number from the filename for page-level
content (e.g., image or text). Returns the page number as a string
with leading zeros. (Note: logic is currently
specific to Gale/ECCO file naming conventions.)</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="corppa.utils.path_utils.get_ppa_source">
<span class="sig-prename descclassname"><span class="pre">corppa.utils.path_utils.</span></span><span class="sig-name descname"><span class="pre">get_ppa_source</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">vol_id</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></span><a class="headerlink" href="#corppa.utils.path_utils.get_ppa_source" title="Link to this definition">¶</a></dt>
<dd><p>For a given volume id, return the corresponding source.
Assume:
* Gale volume ids begin with <code class="docutils literal notranslate"><span class="pre">&quot;CW0&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;CB0&quot;</span></code>
* EEBO-TCP volume ids begin with <code class="docutils literal notranslate"><span class="pre">A</span></code>
* Hathitrust volume ids contain a <code class="docutils literal notranslate"><span class="pre">&quot;.&quot;</span></code></p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="corppa.utils.path_utils.get_stub_dir">
<span class="sig-prename descclassname"><span class="pre">corppa.utils.path_utils.</span></span><span class="sig-name descname"><span class="pre">get_stub_dir</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">source</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">vol_id</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a></span></span><a class="headerlink" href="#corppa.utils.path_utils.get_stub_dir" title="Link to this definition">¶</a></dt>
<dd><p>Returns the stub directory path (<a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">pathlib.Path</span></code></a>) for the specified volume (<code class="docutils literal notranslate"><span class="pre">vol_id</span></code>)</p>
<p>For Gale, the path is formed from every third number (excluding the leading 0)
of the volume identifier.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Ex</span><span class="o">.</span> <span class="n">CB0127060085</span> <span class="o">--&gt;</span> <span class="mi">100</span>
</pre></div>
</div>
<p>For HathiTrust, we use the Stubbytree directory specification created by HTRC.
The path is composed of two directories: (1) the library portion of the volume
identifier and (2) every third character of the encoded volume identifier.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Ex</span><span class="o">.</span> <span class="n">mdp</span><span class="mf">.39015003633594</span> <span class="o">--&gt;</span> <span class="n">mdp</span><span class="o">/</span><span class="mi">31039</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="corppa.utils.path_utils.get_vol_dir">
<span class="sig-prename descclassname"><span class="pre">corppa.utils.path_utils.</span></span><span class="sig-name descname"><span class="pre">get_vol_dir</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">vol_id</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><span class="pre">Path</span></a></span></span><a class="headerlink" href="#corppa.utils.path_utils.get_vol_dir" title="Link to this definition">¶</a></dt>
<dd><p>Returns the volume directory (<a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">pathlib.Path</span></code></a>) for the specified volume (<code class="docutils literal notranslate"><span class="pre">vol_id</span></code>)</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="corppa.utils.path_utils.get_volume_id">
<span class="sig-prename descclassname"><span class="pre">corppa.utils.path_utils.</span></span><span class="sig-name descname"><span class="pre">get_volume_id</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">work_id</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.13)"><span class="pre">str</span></a></span></span><a class="headerlink" href="#corppa.utils.path_utils.get_volume_id" title="Link to this definition">¶</a></dt>
<dd><p>Extract volume id from PPA work id</p>
<ul class="simple">
<li><p>For full works, volume ids and work ids are the same.</p></li>
<li><p>For excerpts, the work id is composed of the prefix followed by “-p” and
the starting page of the excerpt.</p></li>
</ul>
</dd></dl>

</section>
<section id="module-corppa.utils.generate_page_set">
<span id="generate-ppa-page-set"></span><h3>Generate PPA Page Set<a class="headerlink" href="#module-corppa.utils.generate_page_set" title="Link to this heading">¶</a></h3>
<p>Utility for generating a PPA page set.</p>
<p>This method takes three inputs: (1) an input csv, (2) an output csv, and
(3) the size of the page set.</p>
<dl class="simple">
<dt>The input CSV file must have the following fields:</dt><dd><ul class="simple">
<li><p>work_id: PPA work id</p></li>
<li><p>page_start: Starting index for page range being considered for this work</p></li>
<li><p>page_end: Ending index for page range being considered for this work</p></li>
<li><p>poery_pages: Comma separated list of page numbers containing poetry</p></li>
</ul>
</dd>
<dt>The pages are selected as follows:</dt><dd><ul class="simple">
<li><p>First, all pages with poetry are selected</p></li>
<li><p>Then, all remaining pages are chosen randomly (proportionately by work)</p></li>
</ul>
</dd>
<dt>The resulting output CSV file has the following fields:</dt><dd><ul class="simple">
<li><p>work_id: PPA work id</p></li>
<li><p>page_num: Digital page number</p></li>
</ul>
</dd>
</dl>
<p>Example usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">generate_page_set</span><span class="o">.</span><span class="n">py</span> <span class="nb">input</span><span class="o">.</span><span class="n">csv</span> <span class="n">output</span><span class="o">.</span><span class="n">csv</span> <span class="mi">300</span>
</pre></div>
</div>
</section>
<section id="module-corppa.utils.add_image_relpaths">
<span id="add-image-relative-paths"></span><h3>Add Image (Relative) Paths<a class="headerlink" href="#module-corppa.utils.add_image_relpaths" title="Link to this heading">¶</a></h3>
<p>This script adds image relative paths to the PPA full-text corpus. Optionally,
a file extension (e.g., <code class="docutils literal notranslate"><span class="pre">.jpg</span></code>) can be provided to be used for all relative
image paths <cite>instead</cite> of defaulting to their source-level defaults.</p>
<p>Example usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">add_image_relpaths</span><span class="o">.</span><span class="n">py</span> <span class="n">ppa_corpus</span><span class="o">.</span><span class="n">jsonl</span> <span class="n">ppa_with_images</span><span class="o">.</span><span class="n">jsonl</span>

<span class="n">python</span> <span class="n">add_image_relpaths</span><span class="o">.</span><span class="n">py</span> <span class="n">ppa_corpus</span><span class="o">.</span><span class="n">jsonl</span> <span class="n">ppa_with_images</span><span class="o">.</span><span class="n">jsonl</span> <span class="o">--</span><span class="n">ext</span><span class="o">=.</span><span class="n">jpg</span>
</pre></div>
</div>
</section>
<section id="module-corppa.utils.build_text_corpus">
<span id="build-text-corpus"></span><h3>Build Text Corpus<a class="headerlink" href="#module-corppa.utils.build_text_corpus" title="Link to this heading">¶</a></h3>
<p>Script for building a text corpus file (JSONL) from a directory of texts.</p>
<p>This script converts each text (<code class="docutils literal notranslate"><span class="pre">.txt</span></code>) file within an input directory
(including  nested files), and compiles them into a single output text corpus
where each record corresponds to a single text file with the following fields:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">id</span></code>: The name of the file (without prefix)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">text</span></code>: The text of the file (assumes UTF-8 formatting)</p></li>
</ul>
</div></blockquote>
<p>Note that the output file can also be written in any compressed form supported
by <code class="xref py py-mod docutils literal notranslate"><span class="pre">orjsonl</span></code>. If no suffix is provided, <code class="docutils literal notranslate"><span class="pre">.jsonl</span></code> will be used.</p>
<p>Example usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">build_text_corpus</span><span class="o">.</span><span class="n">py</span> <span class="n">input_dir</span> <span class="n">out_corpus</span>

<span class="n">python</span> <span class="n">build_text_corpus</span><span class="o">.</span><span class="n">py</span> <span class="n">input_dir</span> <span class="n">out_corpus</span><span class="o">.</span><span class="n">jsonl</span>

<span class="n">python</span> <span class="n">build_text_corpus</span><span class="o">.</span><span class="n">py</span> <span class="n">input_dir</span> <span class="n">out_corpus</span><span class="o">.</span><span class="n">jsonl</span><span class="o">.</span><span class="n">gz</span>
</pre></div>
</div>
</section>
</section>
<section id="annotation">
<h2>Annotation<a class="headerlink" href="#annotation" title="Link to this heading">¶</a></h2>
<section id="data-preparation">
<h3>Data Preparation<a class="headerlink" href="#data-preparation" title="Link to this heading">¶</a></h3>
<section id="module-corppa.poetry_detection.annotation.create_pageset">
<span id="preliminary-page-set-creation"></span><h4>Preliminary Page Set Creation<a class="headerlink" href="#module-corppa.poetry_detection.annotation.create_pageset" title="Link to this heading">¶</a></h4>
<p>This hard-coded script was used to create a PPA page set for our preliminary
annotation efforts. Note: this script may not work.</p>
<p>This script takes three inputs:</p>
<ol class="arabic simple">
<li><p>A directory for a PPA text corpus</p></li>
<li><p>Our poetry testset file (CSV) that included manual identifications of pages
containing poetry for several works in the PPA</p></li>
<li><p>An output JSONL</p></li>
</ol>
<p>The script then returned a CSV containing page-level metadata for every page of
the PPA works covered in our poetry testet. This page-level metadata included
an image path, if the page is known to contain poetry, and some work-level
information.</p>
<p>Example usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">create_pageset</span><span class="o">.</span><span class="n">py</span> <span class="n">ppa_corpus_dir</span> <span class="n">poetry_testset</span><span class="o">.</span><span class="n">csv</span> <span class="n">out</span><span class="o">.</span><span class="n">jsonl</span>
</pre></div>
</div>
</section>
<section id="module-corppa.poetry_detection.annotation.add_metadata">
<span id="add-metadata"></span><h4>Add Metadata<a class="headerlink" href="#module-corppa.poetry_detection.annotation.add_metadata" title="Link to this heading">¶</a></h4>
<p>This script is used to prepare the page-level PPA corpus data for use in
Prodigy annotation. It adds work-level metadata (title, author, year) in the
locations that Prodigy requires for display, and allows adjusting image paths
for display from the Prodigy interface. It assumes the input page corpus has
corpus has already been annotated with image paths with an <code class="docutils literal notranslate"><span class="pre">image_path</span></code>
attribute using <a class="reference internal" href="#module-corppa.utils.add_image_relpaths" title="corppa.utils.add_image_relpaths"><code class="xref py py-mod docutils literal notranslate"><span class="pre">corppa.utils.add_image_relpaths</span></code></a>.</p>
<p>Example usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">add_metadata</span><span class="o">.</span><span class="n">py</span> <span class="n">ppa_with_images</span><span class="o">.</span><span class="n">jsonl</span> <span class="n">ppa_metadata</span><span class="o">.</span><span class="n">csv</span> <span class="n">out</span><span class="o">.</span><span class="n">jsonl</span>
</pre></div>
</div>
</section>
</section>
<section id="module-corppa.poetry_detection.annotation.annotation_recipes">
<span id="annotation-recipes"></span><h3>Annotation Recipes<a class="headerlink" href="#module-corppa.poetry_detection.annotation.annotation_recipes" title="Link to this heading">¶</a></h3>
<p>This module provides custom recipes for Prodigy annotation. These were
created with page-level annotation in mind and assume a page is associated
with both text and an image. Each recipe displays a page’s image and text
side-by-side.</p>
<dl class="simple">
<dt>Recipes:</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">annotate_page_text</span></code>: Annotate a page’s text.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">annotate_text_and_image</span></code>: Annotate both a page’s text and image side-by-side.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">review_page_spans</span></code>: Review existing page-level text annotations to produce
a final, adjudicated set of annotations.</p></li>
</ul>
</dd>
</dl>
<p>Referenced images must be served out independently for display; the image url
prefix for images should be specified when initializing the recipe.</p>
<p>Example use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prodigy</span> <span class="n">annotate_page_text</span> <span class="n">poetry_spans</span> <span class="n">poetry_pages</span><span class="o">.</span><span class="n">jsonl</span> <span class="o">--</span><span class="n">label</span> <span class="n">POETRY</span><span class="p">,</span><span class="n">PROSODY</span> <span class="o">-</span><span class="n">F</span> <span class="n">annotation_recipes</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="n">prefix</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span>

<span class="n">prodigy</span> <span class="n">annotate_text_and_image</span> <span class="n">poetry_text_image</span> <span class="n">poetry_pages</span><span class="o">.</span><span class="n">jsonl</span> <span class="o">-</span><span class="n">l</span> <span class="n">POETRY</span> <span class="o">-</span><span class="n">F</span> <span class="n">annotation_recipes</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="n">prefix</span> <span class="o">../</span><span class="n">ppa</span><span class="o">-</span><span class="n">web</span><span class="o">-</span><span class="n">images</span> <span class="o">-</span><span class="n">FM</span>

<span class="n">prodigy</span> <span class="n">review_page_spans</span> <span class="n">adjudicate</span> <span class="n">poetry_spans</span> <span class="o">-</span><span class="n">l</span> <span class="n">POETRY</span> <span class="o">-</span><span class="n">F</span> <span class="n">annotation_recipes</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="n">prefix</span> <span class="o">../</span><span class="n">ppa</span><span class="o">-</span><span class="n">web</span><span class="o">-</span><span class="n">images</span> <span class="o">-</span><span class="n">FM</span> <span class="o">--</span><span class="n">sessions</span> <span class="n">alice</span><span class="p">,</span><span class="n">bob</span>
</pre></div>
</div>
</section>
<section id="module-corppa.poetry_detection.annotation.command_recipes">
<span id="command-recipes"></span><h3>Command Recipes<a class="headerlink" href="#module-corppa.poetry_detection.annotation.command_recipes" title="Link to this heading">¶</a></h3>
<p>This module contains custom command recipes for Prodigy.</p>
<p>Recipes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ppa-task-progress</span></code>: Report the current progress for a PPA annotation task
at the page and annotator level.</p></li>
</ul>
<p>Example use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prodigy</span> <span class="n">ppa</span><span class="o">-</span><span class="n">stats</span> <span class="n">task_id</span> <span class="o">-</span><span class="n">F</span> <span class="n">command_recipes</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</section>
<section id="module-corppa.poetry_detection.annotation.process_adjudication_data">
<span id="process-adjudication-data"></span><h3>Process Adjudication Data<a class="headerlink" href="#module-corppa.poetry_detection.annotation.process_adjudication_data" title="Link to this heading">¶</a></h3>
<p>This script processes the adjudication data produced by Prodigy for our
poetry detection task into two outputs:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>A JSONL file that compiles the annotation data into page-level records.
So, each record contains some page-level metdata and the compiled list
of poetry excerpts (if any) determined in the adjudication process.</p></li>
<li><p>A CSV file containing excerpt-level data per line.</p></li>
</ol>
</div></blockquote>
<p>Note that the first file explicitly include information on the pages where
no poetry was identified, while the second will only implicitly through
absence and requires external knowledge of what pages were covered in
the annotation rounds. So, the former is particularly useful for the evaluation
process while the latter is better suited for building a final excerpt dataset.</p>
<p>Example command line usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">process_adjudication_data</span><span class="o">.</span><span class="n">py</span> <span class="n">prodigy_data</span><span class="o">.</span><span class="n">jsonl</span> <span class="n">adj_pages</span><span class="o">.</span><span class="n">jsonl</span> <span class="n">adj_excerpts</span><span class="o">.</span><span class="n">csv</span>
</pre></div>
</div>
</section>
</section>
<section id="poetry-detection">
<h2>Poetry Detection<a class="headerlink" href="#poetry-detection" title="Link to this heading">¶</a></h2>
<section id="scripts">
<h3>Scripts<a class="headerlink" href="#scripts" title="Link to this heading">¶</a></h3>
<section id="module-corppa.poetry_detection.refmatcha">
<span id="refmatcha"></span><h4>refmatcha<a class="headerlink" href="#module-corppa.poetry_detection.refmatcha" title="Link to this heading">¶</a></h4>
<p><em>🎶🍵 matcha matcha poem / This script is gon / na find your poems / matcha matcha poem 🎶🍵</em></p>
<p>refmatcha identifies poem excerpts by matching against a local collection of
reference poems.  It takes in a CSV of unidentified excerpts and outputs a CSV of
labeled excerpts for those excerpts it is able to identify.
By default, the output file is created in the same directory as the input
with the same name plus <cite>_matches</cite>; i.e., given an input file <cite>round1_excerpts.csv</cite>,
refmatcha will output identified excerpts to <cite>round1_excerpts_matches.csv</cite>.
To override this, specify an output filename with <cite>–output</cite> or <cite>-o</cite>.</p>
<p>Setup:</p>
<p>Download and extract <cite>poetry-ref-data.tar.bz2</cite> from <cite>/tigerdata/cdh/prosody/poetry-detection</cite>.
You should extract it in the same directory where you plan to run this script.
The script will compile reference content into full-text and metadata parquet files
on the first run; to force recompilation, rename or remove the parquet files.</p>
<p>Example usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">refmatcha</span> <span class="n">round1_excerpts</span><span class="o">.</span><span class="n">csv</span>
<span class="n">refmatcha</span> <span class="n">round1_excerpts</span><span class="o">.</span><span class="n">csv</span> <span class="o">--</span><span class="n">output</span> <span class="n">round1_matches</span><span class="o">.</span><span class="n">csv</span>
</pre></div>
</div>
</section>
<section id="module-corppa.poetry_detection.merge_excerpts">
<span id="merge-excerpts"></span><h4>Merge excerpts<a class="headerlink" href="#module-corppa.poetry_detection.merge_excerpts" title="Link to this heading">¶</a></h4>
<p>This script merges labeled and unlabeled poem excerpts, combining
notes for any merged excerpts, and merging duplicate poem identifications
in simple cases.</p>
<p>It takes two or more input files of excerpt data (labeled or unlabeled) in CSV format,
merges any excerpts that can be combined, and outputs a CSV with the updated excerpt data.
All excerpts in the input data files are preserved in the output, whether
they were merged with any other records or not. This means that in most cases,
the output will likely be a mix of labeled and unlabeled excerpts.</p>
<p>Merging logic is as follows:</p>
<ul>
<li><p>Excerpts are grouped on the combination of page id and excerpt id,
and then merged if all reference fields match exactly, or where
reference fields are present in one excerpt and unset in the other.</p>
<blockquote>
<div><ul class="simple">
<li><p>If the same excerpt has different labels (different <cite>poem_id</cite> values), both
labeled excerpts will be included in the output</p></li>
<li><p>If the same excerpt has duplicate labels (i.e., the same <cite>poem_id</cite> from two
different identification methods), they will be merged
into a single labeled excerpt; the <cite>identification_methods</cite> in the
resulting labeled excerpt will be the union of methods in the merged excerpts</p></li>
</ul>
</div></blockquote>
</li>
<li><p>When merging excerpts where both records have notes, notes content
will be combined.</p></li>
</ul>
<p>Example usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">src</span><span class="o">/</span><span class="n">corppa</span><span class="o">/</span><span class="n">poetry_detection</span><span class="o">/</span><span class="n">merge_excerpts</span><span class="o">.</span><span class="n">py</span> <span class="n">adjudication_excerpts</span><span class="o">.</span><span class="n">csv</span> <span class="n">labeled_excerpts</span><span class="o">.</span><span class="n">csv</span> <span class="o">-</span><span class="n">o</span> <span class="n">merged_excerpts</span><span class="o">.</span><span class="n">csv</span>
</pre></div>
</div>
<p>Limitations:</p>
<ul class="simple">
<li><p>Labeled excerpts with the same poem_id but different reference data
will not be merged; supporting multiple identification methods that output
span information will likely require more sophisticated merge logic</p></li>
<li><p>CSV input and output only (JSONL may be added in future)</p></li>
<li><p>Notes are currently merged only with the first matching excerpt; if an 
unlabeled excerpt with notes has multiple labels, only the first match
will have combined notes</p></li>
</ul>
</section>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">corppa</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="readme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-notes.html">Developer Notes</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Code Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#module-corppa.ocr.gvision_ocr">OCR</a></li>
<li class="toctree-l2"><a class="reference internal" href="#utils">Utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="#annotation">Annotation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#poetry-detection">Poetry Detection</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="eop-docs.html">Ends of Prosody: corppa utilities</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="dev-notes.html" title="previous chapter">Developer Notes</a></li>
      <li>Next: <a href="eop-docs.html" title="next chapter">Ends of Prosody: corppa utilities</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Princeton CDH RSE Team.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/code-docs.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>